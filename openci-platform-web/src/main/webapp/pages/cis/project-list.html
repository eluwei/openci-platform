<div id="projectGrid"></div>
<script>
	$(function() {
		var columns = [{
			title : '项目名称',
			name : 'name',
			width : 150
		}, {
			title : '开发者',
			name : 'developers',
			width : 250,
			render : function(item, name, index) {
				var developers = [];
				$.each(item[name], function() {
					developers.push(this.developer.name);
				});
				return developers.join(',');
			}
		}, {
			title : '集成工具',
			name : 'tools',
			width : 250,
			render : function(item, name, index) {
				var tools = [];
				$.each(item[name], function() {
					tools.push('<a href="' + this.toolRequestAddress + '" target="_">' + this.toolConfiguration.name + '</a>');
				});
				return tools.join(',');
			}
		}, {
			title : '项目状态',
			name : 'projectStatus',
			width : 150,
			render : function(item, name, index) {
				switch(item[name]) {
					case 'SUCCESS':
						return '<span style="font-weight:bold; color:#5CB85C;">创建成功</span>';
					case 'INTEGRATION_TOOL_FAILURE':
						return '<span style="font-weight:bold; color:#D9534F;">创建失败</span>';
					case 'INTEGRATION_TOOL':
						return '<div class="progress progress-striped active" title="正在整合工具" data-value="' + item.id + '"><div class="progress-bar" style="width: 100%"></div></div>';
					default:
						return item[name]
				}
			}
		}, {
			title : '创建时间',
			name : 'projectCreateDate',
			width : 150
		}, {
			title : '操作',
			name : 'projectSavePath',
			width : 180,
			render : function(item, name, index) {
				return '<button class="btn btn-primary" type="button" onclick="showProjectDetail(' + item.id + ')"><span class="glyphicon glyphicon-search"><span>查看</button>&nbsp;&nbsp;&nbsp;<button class="btn btn-danger" type="button" onclick="deleteProject(' + item.id + ')"><span class="glyphicon glyphicon-remove"><span>删除</button>';
			}
		}];
		$('#projectGrid').grid({
			identity : 'id',
			columns : columns,
			querys : [{
				title : '项目名称',
				value : 'name'
			}],
			url : 'project/pagingquery'
		}).on('complate', function() {
			$(this).find('.progress').each(function() {
				var $td = $(this).closest('td');
				var id = $(this).data('value');
				var intervalId = setInterval(function() {
					$.get('project/detail/' + id).done(function(data) {
						var projectStatus = data.projectStatus
						if (projectStatus == 'SUCCESS') {
							$td.html('<span style="font-weight:bold; color:#5CB85C;">创建成功</span>');
							clearInterval(intervalId);
						} else if (projectStatus == 'INTEGRATION_TOOL_FAILURE') {
							$td.html('<span style="font-weight:bold; color:#D9534F;">创建失败</span>');
							clearInterval(intervalId);
						}
					});
				}, 2000);
			});
		});
	});

	var showProjectDetail = function(id) {
		$.get('project/detail/' + id).done(function(project) {
			$.get('pages/cis/project-detail.html').done(function(data) {
				var dialog = $(data);
				dialog.find('#name').html(project.name);
				dialog.find('#groupId').html(project.projectDetail.groupId);
				dialog.find('#artifactId').html(project.projectDetail.artifactId);
				var projectStatus = dialog.find('#projectStatus');
				switch(project.projectStatus) {
					case 'SUCCESS':
						projectStatus.html('<span style="font-weight:bold; color:#5CB85C;">创建成功</span>');
						break;
					case 'INTEGRATION_TOOL_FAILURE':
						projectStatus.html('<span style="font-weight:bold; color:#D9534F;">创建失败</span>');
						break;
					case 'INTEGRATION_TOOL':
						projectStatus.html('<div class="progress progress-striped active" title="正在整合工具"><div class="progress-bar" style="width: 100%"></div></div>');
						break;
					default:
						projectStatus.html(project.projectStatus);
						break;
				}
				//dialog.find('#projectStatus').html(project.projectStatus);
				dialog.find('#projectSavePath').html(project.projectDetail.projectSavePath);
				dialog.find('#createDate').html(project.projectCreateDate);
				var devlopers = [];
				$.each(project.developers, function() {
					devlopers.push('&nbsp;&nbsp;' + this.developer.name);
				});
				dialog.find('#devlopers').html(devlopers.join(','));
				var tools = [];
				$.each(project.tools, function() {
					var html = [];
					var toolStatus = '';
					switch(this.status) {
						case 'SUCCESS':
							toolStatus = '<span style="font-weight:bold; color:#5CB85C;">整合成功</span>';
							break;
						case 'FAILURE':
							toolStatus = '<span style="font-weight:bold; color:#D9534F;">整合失败</span>';
							break;
						default :
							toolStatus = '<span style="font-weight:bold; color:#D9534F;">正在整合工具</span>';
							break;
					}
					html.push('<div class="panel panel-default"><div class="panel-heading">' + this.toolConfiguration.name + '(' + toolStatus + ')</div><table class="table"><thead><tr><th class="first">创建过程</th><th class="second">时间</th><th class="third">结果</th></tr></thead><tbody>');
					$.each(this.toolInterfaceImplements, function() {
						var result = '';
						if (this.success) {
							result = '<span style="font-weight:bold;color:#5CB85C">成功</span>';
						} else {
							result = '<span style="font-weight:bold;color:#D9534F">失败(' + (this.record == 'null' ? '' : this.record) + ')</span>';
						}
						html.push('<tr><td class="first">' + this.toolInterface + '</td><td class="second">' + this.executeDate + '</td><td class="third">' + result + '</td></tr>');
					});
					html.push('</tbody></table></div>');
					tools.push(html.join(''));
				});
				dialog.find('#tools').html(tools.join(''));
				dialog.modal({
					keyboard : false
				}).on({
					'hidden.bs.modal' : function() {
						$(this).remove();
					}
				});
			});
		});
	}
	var deleteProject = function(id) {
		$('#projectGrid').confirm({
			content : '确定要删除该项目吗?',
			callBack : function() {
				$.post('project/remove/' + id).done(function(result) {
					if (result) {
						$('#projectGrid').message({
							type : 'success',
							content : '删除成功'
						});
						$('#projectGrid').grid('refresh');
					} else {
						$('#projectGrid').message({
							type : 'error',
							content : '删除失败'
						});
					}
				});
			}
		});
	}
</script>
